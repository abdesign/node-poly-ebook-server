<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/effects/waterfall.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">

<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-styles/color.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">


<!--<link rel="import" href="../bower_components/neon-animation/animations/scale-up-animation.html">-->
<!--<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">-->
<!--<link rel="import" href="../bower_components/neon-animation/animations/fade-in-animation.html">-->
<!--<link rel="import" href="../bower_components/neon-animation/animations/slide-down-animation.html">-->
<!--<link rel="import" href="../bower_components/neon-animation/neon-animation-runner-behavior.html">-->



<dom-module id="poly-ebook-view" >
    <template>

        <style is="custom-style">
            :root {
                --ebooks-green: #00ca8b;
                --ebooks-red: #fd5d57;
                --ebooks-yellow: #ffc92a;

                --primary-text-color: #c6d9f1;

                --paper-input-container-label: {
                    color: var(--primary-text-color);
                };
                --paper-listbox-background-color: #262f3a;

                --paper-toolbar-background: rgb(43, 54, 67);
                --paper-toolbar-color: var(--primary-text-color);

                --paper-input-container-color: #99a6b9;
                --paper-input-container-focus-color: #408ff9;
                --paper-input-container-invalid-color: var(--ebooks-red);
                --paper-input-container-input-color: var(--primary-text-color);
                --paper-tabs-selection-bar-color: var(--ebooks-yellow);

                --photo-content-detail : {
                    background: rgba(63, 79, 99, 0.85);
                };
                --thumb-link-color: #fff;
            }

            :host {
                display: block;
                @apply(--paper-font-common-base);
            }

            paper-fab.rotated {
                transform: rotate(-90deg);
                transform-origin: 50% 50%;
            }

            #scrollLetterView {
                --paper-fab-background: var(--paper-light-blue-500);
                --paper-fab-keyboard-focus-background: var(--paper-light-blue-900);
            }
            .deleteIcon {
                --paper-fab-background: var(--paper-light-blue-500);
                --paper-fab-keyboard-focus-background: var(--paper-light-blue-900);
            }
            #scrollLetterView, #dd1, #dd2, #dd3, #dd4 {
                position:fixed;top: 50%; right: 10px;
            }
            #dd1, #dd2, #dd3, #dd4 {
                --paper-fab-background: var(--paper-toolbar-background);
                --paper-fab-keyboard-focus-background: var(--primary-text-color);
            }

            #dd1 {margin-top: -120px;}
            #dd2 {margin-top: -60px;}
            #dd3 {margin-top: 60px;}
            #dd4 {margin-top: 120px;}



            app-header paper-dropdown-menu {
                margin-left: 40px;
                margin-right: 40px;
            }

            app-header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                z-index: 1;
                background-color: var(--paper-toolbar-background);
                color: var(--primary-text-color);
                --app-header-background-front-layer: {
                    background: var(--paper-toolbar-background);
                };
            }


            app-header paper-tabs {
                margin-right:40px;
            }

            span.green {
                color: var(--ebooks-green);
            }
            span.yellow {
                color: var(--ebooks-yellow);
            }
            span.red {
                color: var(--ebooks-red);
            }

            iron-list {
                margin-top: 80px;
                padding-bottom: 20px;
            }

            .thumbContent {
                @apply(--layout);
                /*background-color: var(--paper-toolbar-background);*/
                position: relative;
                margin: 0px;
            }

            .thumbContent:hover .detail {
                opacity: 1;
            }

            .thumbContent .label {
                background-color: transparent;
                color: var(--primary-text-color);
                position: absolute;
                left: 0;
                top: 0;
                /*width:100px;;*/
                overflow: hidden;
            }

            .thumbContent > iron-image {
                @apply(--layout-flex);
            }

            .thumbContent > .detail {
                @apply(--photo-content-detail);
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                font-size: 18px;
                font-weight: bold;
                padding: 0;
                opacity: 0;
                transition: opacity 0.1s;
            }

            .thumbContent > .detail > a, .thumbContent > .detail > .blue {
                color: var(--thumb-link-color);
                cursor: pointer;
                text-decoration: inherit;
            }
            paper-fab.blue {
                --paper-fab-background: var(--paper-light-blue-500);
                --paper-fab-keyboard-focus-background: var(--paper-light-blue-900);
            }

            .self-end {
                /* This mixin (from iron-flex-layout) aligns the tabs to the bottom of the toolbar. */
                @apply(--layout-self-end);
            }
            #toastSuccess {
                --paper-toast-background-color: var(--ebooks-yellow);
                --paper-toast-color: var(--paper-listbox-background-color);
            }
        </style>

        <iron-ajax auto url="../init.json" handle-as="json" last-response="{{options}}"></iron-ajax>
        <iron-ajax auto url="{{_getLoadFilesUrl(options.sectionIndex)}}" handle-as="json" last-response="{{files}}"></iron-ajax>

        <iron-ajax id="ajaxDelete" method="DELETE" on-response="afterDelete"></iron-ajax>
        <iron-ajax id="ajaxGet" method="GET" on-response="onAjaxGetResponse"></iron-ajax>

        <paper-toast id="toastSuccess" class="fit-bottom"  text="[[toastSuccessText]]"></paper-toast>

        <app-header condenses fixed effects="blend-background waterfall">
            <app-toolbar>

                <h4 title>[[options.title]] (<span class$="{{counterclass}}"><span hidden$="{{ishidden}}">{{filteredFiles.length}} / </span>{{files.length}}</span>)</h4>

                <paper-tabs id="sectionTabs" selected="{{options.sectionIndex}}" class="bottom self-end">
                    <template is="dom-repeat" items="{{options.sections}}">
                        <paper-tab>{{item.label}}</paper-tab>
                    </template>
                </paper-tabs>

                <paper-input label="Search" value="{{searchText::input}}">
                    <iron-icon icon="search" prefix></iron-icon>
                    <iron-icon suffix hidden$="{{!searchText}}" on-tap="clearInput" icon="clear" alt="clear" title="clear"></iron-icon>
                </paper-input>

                <paper-dropdown-menu label="Thumb Sizes">
                    <paper-listbox class="dropdown-content" selected="{{thumbDimsIndex}}">
                        <template is="dom-repeat" items="{{thumbDims}}">
                            <paper-item>{{item.width}} x {{item.height}}</paper-item>
                        </template>
                    </paper-listbox>
                </paper-dropdown-menu>

                <paper-icon-button hidden$="{{isFullScreen()}}" icon="fullscreen" on-tap="toggleFullScreen"></paper-icon-button>
                <paper-icon-button hidden$="{{!isFullScreen()}}" icon="fullscreen-exit" on-tap="toggleFullScreen"></paper-icon-button>
            </app-toolbar>
        </app-header>

        <iron-list id="list" items="{{filteredFiles}}" as="file" scroll-target="document" grid>
            <template>
                <div class="thumbContainer">
                    <div class="thumbContent" style$="{{thumbCss}}" tabindex$="[[tabIndex]]" title="{{index}}) [[_computeTitle(file)]]">

                        <div class="label">{{getName(file)}}</div>

                        <iron-image sizing="cover" src="[[_computeImgUrl(file)]]"></iron-image>

                        <div class="detail horizontal layout">
                            <a href="../[[file]]" target="_blank">
                                <paper-fab mini icon="cloud-download"></paper-fab>
                            </a>
                            <paper-fab mini hidden$="{{!deleteVisible}}" icon="delete" class="deleteIcon" on-tap="deleteFile"></paper-fab>
                            <paper-fab mini hidden$="{{!copyVisible}}" icon="content-copy" class="blue copyIcon" on-tap="copyFile"></paper-fab>
                            <paper-fab mini hidden$="{{!sendLinkVisible}}" icon="send" class="blue" on-tap="sendLink"></paper-fab>
                            <paper-fab mini hidden$="{{!sendAttachmentVisible}}" icon="attachment" class="blue copyIcon" on-tap="sendAttachment"></paper-fab>
                        </div>
                    </div>
                </div>
            </template>
        </iron-list>


        <paper-fab  id="dd1" hidden$="{{!scrollControlVisible}}" on-click="scroll2Top" icon="av:skip-next" class="rotated"></paper-fab>
        <paper-fab  id="dd2" hidden$="{{!scrollControlVisible}}" on-click="scrollUp" icon="av:fast-forward" class="rotated"></paper-fab>

        <paper-fab id="scrollLetterView" label="[[scrollLetter]]" on-click="openDropdown"></paper-fab>

        <paper-fab  id="dd3" hidden$="{{!scrollControlVisible}}" on-click="scrollDown" icon="av:fast-rewind" class="rotated"></paper-fab>
        <paper-fab  id="dd4" hidden$="{{!scrollControlVisible}}" on-click="scroll2End" icon="av:skip-previous" class="rotated"></paper-fab>

    </template>

    <script>
        HTMLImports.whenReady(function () {

            Polymer({
                is: 'poly-ebook-view',
//                behaviors: [Polymer.NeonAnimationRunnerBehavior],
                properties: {
                    options: Object,
                    files: Array,
                    toastSuccessText: 'File copied successfully.',
                    filteredFiles: {
                        type: Array,
                        value: []
                    },
                    deleteVisible: {
                        type: Boolean,
                        value: false
                    },
                    copyVisible: {
                        type: Boolean,
                        value: false
                    },
                    sendLinkVisible: {
                        type: Boolean,
                        value: false
                    },
                    sendAttachmentVisible: {
                        type: Boolean,
                        value: false
                    },
                    thumbDims: Array,
                    thumbDimsIndex: Number,
                    thumbCss: String,
                    counterclass: {
                        type: String,
                        value: 'green'
                    },
                    searchText: {
                        type: String,
                        value: ''
                    },
                    ishidden: {
                        type: Boolean,
                        value: true
                    },
                    scrollControlVisible: {
                        type: Boolean,
                        value: false
                    },
                    scrollLetter: '',
                    listEle: HTMLElement,
                    actionFile: ''
//                    animationConfig: {
//                        value: function() {
//                            return {
//                                'entry': {
//                                    name: 'bounce-in-animation',
//                                    node: this,
//                                    timing: {duration: 1000}
//                                },
//                                'exit': {
//                                    name: 'fade-out-animation',
//                                    node: this
//                                }
//                            }
//                        }
//                    }
                },
                observers: [
                    '_filterFiles(files, searchText)',
                    '_resetBySectionIndex(options.sectionIndex)',
                    '_resetByThumbDimsIndex(thumbDimsIndex)'
                ],
//                listeners: {
//                    'neon-animation-finish': '_onNeonAnimationFinish'
//                },
                getName: function(file){
                    var i = Math.max(file.lastIndexOf('\\'), file.lastIndexOf('/')) +1;
                    return file.substr(i);
                },
                deleteFile: function (event, detail, sender) {
                    this.actionFile = event.model.file;
                    var url = event.model.file.replace('file/', 'delete/');

                    if (!confirm('Do you really want to delete ' + url + '?')) return;

                    this.$.ajaxDelete.url = url;
                    this.$.ajaxDelete.generateRequest();
                },
                afterDelete: function(){
                    console.info('deleted ', this.actionFile);

                    var i = this.filteredFiles.indexOf(this.actionFile);
                    if (i > -1) this.filteredFiles.splice(i, 1);
                    i = this.files.indexOf(this.actionFile);
                    if (i > -1) this.files.splice(i, 1);
                    this.listEle.fire('iron-resize');
                },
                copyFile: function (event, detail, sender) {
                    this.actionFile = event.model.file;
                    var url = event.model.file.replace('file/', 'copy/');
                    //if (!confirm('Do you really want to copy ' + url + '?')) return;
                    this.$.ajaxGet.url = url;
                    this.onAjaxGetResponse = this.afterCopy;
                    this.$.ajaxGet.generateRequest();
                },
                sendAttachment: function (event, detail, sender) {
                    this.actionFile = event.model.file;
                    var url = event.model.file.replace('file/', 'sendattachment/');
                    //if (!confirm('Do you really want to copy ' + url + '?')) return;
                    this.$.ajaxGet.url = url;
                    this.onAjaxGetResponse = this.afterSendAttachment;
                    this.$.ajaxGet.generateRequest();
                },
                sendLink: function (event, detail, sender) {
                    this.actionFile = event.model.file;
                    var url = event.model.file.replace('file/', 'sendlink/');
                    //if (!confirm('Do you really want to copy ' + url + '?')) return;
                    this.$.ajaxGet.url = url;
                    this.onAjaxGetResponse = this.afterSendLink;
                    this.$.ajaxGet.generateRequest();
                },
                onAjaxGetResponse: function(){},
                afterCopy: function(){
                    console.log('afterCopy');
                    this.toastSuccessText = 'File copied successfully.';
                    this.$.toastSuccess.open();
                },
                afterSendAttachment: function(){
                    console.log('afterSendAttachment');
                    this.toastSuccessText = 'Sent attachment successfully.';
                    this.$.toastSuccess.open();
                },
                afterSendLink: function(){
                    console.log('afterSendLink');
                    this.toastSuccessText = 'Sent link successfully.';
                    this.$.toastSuccess.open();
                },

                openDropdown: function(){
                    this.scrollControlVisible = !this.scrollControlVisible;
//                    if (this.scrollControlVisible) {
//                        this.show();
//                    } else {
//                        this.hide();
//                    }
                },
                scroll2Top: function(){
                    this.listEle.scrollToIndex(0);
                },
                scrollUp: function(){
                    this.listEle.scrollToIndex(Math.round(this.listEle.firstVisibleIndex - this.filteredFiles.length/10));
                },
                scrollDown: function(){
                    this.listEle.scrollToIndex(Math.round(this.listEle.firstVisibleIndex + this.filteredFiles.length/10));
                },
                scroll2End: function(){
                    this.listEle.scrollToIndex(this.filteredFiles.length - 1);
                },
                clearInput: function(){
                    this.searchText = '';
                },
                isFullScreen: function () {
                    return !(!document.fullscreenElement && !document.mozFullScreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement);
                },
                toggleFullScreen: function () {
                    // https://developer.mozilla.org/en-US/docs/Web/API/Fullscreen_API
                    if (!this.isFullScreen()) {
                        var documentElement = document.documentElement;
                        if (documentElement.requestFullscreen) {
                            documentElement.requestFullscreen();
                        } else if (documentElement.msRequestFullscreen) {
                            documentElement.msRequestFullscreen();
                        } else if (documentElement.mozRequestFullScreen) {
                            documentElement.mozRequestFullScreen();
                        } else if (documentElement.webkitRequestFullscreen) {
                            documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
                        }
                    } else {
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                        } else if (document.msExitFullscreen) {
                            document.msExitFullscreen();
                        } else if (document.mozCancelFullScreen) {
                            document.mozCancelFullScreen();
                        } else if (document.webkitExitFullscreen) {
                            document.webkitExitFullscreen();
                        }
                    }
                },

                _resetByThumbDimsIndex: function(thumbDimsIndex){
                    this.scrollLetter = '';
                    this.thumbCss = [
                        'width:', this.thumbDims[this.thumbDimsIndex].width,'px;',
                        'height:', this.thumbDims[this.thumbDimsIndex].height, 'px;'
                    ].join('');
                    document.querySelector('iron-list').fire('iron-resize');
                },
                _resetBySectionIndex: function(sectionIndex){
                    this.scrollLetter = '';
                    var section = this.options.sections[sectionIndex];
                    this.searchText = section.initialFilter;
                    this.thumbDims = section.thumbsDims;
                    this.thumbDimsIndex = section.dimIndex;
                    this.deleteVisible = !!section.trashDir;
                    this.copyVisible = !!section.copyDir;
                    this.sendLinkVisible = !!(section.sendOptions && section.sendOptions.sendlink);
                    this.sendAttachmentVisible = !!(section.sendOptions && section.sendOptions.sendattachment);
                    this._resetByThumbDimsIndex(this.thumbDimsIndex);
                },
                _filterFiles: function(files, searchText){
                    var ret;
                    var filterWords;
                    this.scrollLetter = '';

                    var isOk = function isOk(value) {
                        for (var i = 0; i < filterWords.length; i++) {
                            var word = filterWords[i];
                            if (word && word.length > 0) {
                                var chr0 = word.substr(0, 1);
                                if (chr0 === '!' || chr0 === '-') {
                                    // '-abc' --> word 'abc' is not allowed:
                                    if (word.length > 1 && value.toLowerCase().indexOf(word.substr(1)) > -1) return false;
                                } else {
                                    if (value.toLowerCase().indexOf(word) === -1) return false;
                                }
                            }
                        }
                        return true;
                    };

                    if (!files) ret = null;
                    if (!ret && !searchText) ret= files;

                    if (!ret) {
                        filterWords = searchText.toLowerCase().split(' ');
                        ret = files.filter(isOk);
                    }
                    this.scrollControlVisible = false;
                    //this.hide();

                    this.filteredFiles = ret;
                    this.ishidden = this.filteredFiles.length === this.files.length;
                    this.counterclass = this.filteredFiles.length === 0 ? 'red' : (this.ishidden ? 'green': 'yellow');
                    this.listEle.fire('iron-resize');
                },
                _getLoadFilesUrl: function (sectionIndex) {
                    if (sectionIndex==undefined) return null;
                    return '/'+ sectionIndex+'/files.json';
                },
                _computeTitle: function (file) {
                    return file.substring(1 + file.lastIndexOf('/'));
                },
                _computeImgUrl: function (file) {
                    var img = file.replace('file/', 'img/');
                    img = img.substr(0, img.lastIndexOf('.')) + '.jpg';
                    return img;
                },


//                show: function() {
//                    this.scrollControlVisible = true;
//                    //this.style.display = 'inline-block';
//                    this.$.dd1.style.display = 'inline-block';
//                    this.$.dd2.style.display = 'inline-block';
//                    this.$.dd3.style.display = 'inline-block';
//                    this.$.dd4.style.display = 'inline-block';
//                    this.cancelAnimation();
//                    this.playAnimation('entry');
//                },
//                hide: function() {
//                    this.scrollControlVisible = false;
//                    this.cancelAnimation();
//                    this.playAnimation('exit');
//                },
//                _onNeonAnimationFinish: function() {
//                    if (!this.scrollControlVisible) {
//                        this.$.dd1.style.display = 'none';
//                        this.$.dd2.style.display = 'none';
//                        this.$.dd3.style.display = 'none';
//                        this.$.dd4.style.display = 'none';
//                    }
//                },

                attached: function () {
                    console.info('attached...');
                    var list = document.querySelector('iron-list');
                    this.listEle = this.$.list;
                    var self = this;
//                    this.hide();
                    var scrollListener = function () {
                        var item= self.filteredFiles[list.firstVisibleIndex];
                        self.scrollLetter = item.substr(item.lastIndexOf('/')+1, 1).trim().toUpperCase();
                        //self.scrollControlVisible = false;
                    };
                    window.addEventListener('scroll', scrollListener);
                },
                ready: function () {
                    console.info('ready...');
                }
            });

        });

    </script>

</dom-module>