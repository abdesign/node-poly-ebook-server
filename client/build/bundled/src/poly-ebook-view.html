<html><head><link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/effects/waterfall.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">

<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-styles/color.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">


<link rel="import" href="thumb-div.html">
<link rel="import" href="toggle-fullscreen-button.html">


</head><body><dom-module id="poly-ebook-view">
    <template>

        <style is="custom-style">:root{--ebooks-green:#98ee9a;--ebooks-red:#fa8577;--ebooks-yellow:#face5c;--primary-text-color:#fff;--paper-input-container-label:{color:var(--primary-text-color);};--paper-listbox-background-color:#363b4e;--paper-toolbar-background:#262831;--paper-toolbar-color:var(--primary-text-color);--paper-input-container-color:#99a6b9;--paper-input-container-focus-color:#4994f6;--paper-input-container-invalid-color:var(--ebooks-red);--paper-input-container-input-color:var(--primary-text-color);--paper-tabs-selection-bar-color:var(--ebooks-yellow);--photo-content-detail:{background:rgba(63, 79, 99, 0.85);};--thumb-link-color:#fff;}:host{display:block;@apply (--paper-font-common-base);}paper-fab.rotated{transform:rotate(-90deg);transform-origin:50% 50%;}#scrollLetterView{--paper-fab-background:var(--paper-light-blue-500);--paper-fab-keyboard-focus-background:var(--paper-light-blue-900);}.deleteIcon{--paper-fab-background:var(--paper-light-blue-500);--paper-fab-keyboard-focus-background:var(--paper-light-blue-900);}#scrollLetterView, #dd1, #dd2, #dd3, #dd4{position:fixed;top:50%;right:10px;}#dd1, #dd2, #dd3, #dd4{--paper-fab-background:var(--paper-toolbar-background);--paper-fab-keyboard-focus-background:var(--primary-text-color);}#dd1{margin-top:-120px;}#dd2{margin-top:-60px;}#dd3{margin-top:60px;}#dd4{margin-top:120px;}app-header paper-dropdown-menu{margin-left:40px;margin-right:40px;}app-header{position:fixed;top:0;left:0;right:0;z-index:1;background-color:var(--paper-toolbar-background);color:var(--primary-text-color);--app-header-background-front-layer:{background:var(--paper-toolbar-background);};}app-header paper-tabs{margin-right:40px;}span.green{color:var(--ebooks-green);}span.yellow{color:var(--ebooks-yellow);}span.red{color:var(--ebooks-red);}iron-list{margin-top:80px;padding-bottom:20px;}.self-end{@apply (--layout-self-end);}#toastSuccess{--paper-toast-background-color:var(--ebooks-yellow);--paper-toast-color:var(--paper-listbox-background-color);}#toastError{--paper-toast-background-color:var(--ebooks-red);--paper-toast-color:var(--thumb-link-color);}</style>

        <iron-ajax auto="" url="../init.json" handle-as="json" last-response="{{options}}"></iron-ajax>
        <iron-ajax auto="" url="{{_getLoadFilesUrl(options.sectionIndex)}}" handle-as="json" last-response="{{files}}" on-response="_calcScrollLetter"></iron-ajax>
        <iron-ajax id="ajaxGet" method="GET" last-response="{{ajaxGetResponse}}"></iron-ajax>

        <paper-toast id="toastSuccess" class="fit-bottom" text="[[toastSuccessText]]"></paper-toast>
        <paper-toast id="toastError" class="fit-bottom" text="[[toastErrorText]]"></paper-toast>

        <app-header condenses="" fixed="" effects="blend-background waterfall">
            <app-toolbar>

                <h4 title="">[[options.title]] (<span class$="{{counterclass}}"><span hidden$="{{itemCounterHidden}}">{{filteredFiles.length}} / </span>{{files.length}}</span>)</h4>

                <paper-tabs id="sectionTabs" selected="{{options.sectionIndex}}" class="bottom self-end">
                    <template is="dom-repeat" items="{{options.sections}}">
                        <paper-tab>{{item.label}}</paper-tab>
                    </template>
                </paper-tabs>

                <paper-input label="Search" value="{{searchText::input}}">
                    <iron-icon icon="search" prefix=""></iron-icon>
                    <iron-icon suffix="" hidden$="{{!searchText}}" on-tap="clearInput" icon="clear" alt="clear" title="clear"></iron-icon>
                </paper-input>

                <paper-dropdown-menu label="Thumb Sizes">
                    <paper-listbox class="dropdown-content" selected="{{thumbDimsIndex}}">
                        <template is="dom-repeat" items="{{thumbDims}}">
                            <paper-item>{{item.width}} x {{item.height}}</paper-item>
                        </template>
                    </paper-listbox>
                </paper-dropdown-menu>

                <toggle-fullscreen-button></toggle-fullscreen-button>
            </app-toolbar>
        </app-header>

        <iron-list id="list" items="{{filteredFiles}}" as="file" scroll-target="document" grid="">
            <template>
                <thumb-div file="[[file]]" thumb-css="[[thumbCss]]" tab-index="[[tabIndex]]" index="[[index]]" delete-visible="[[deleteVisible]]" copy-visible="[[copyVisible]]" sendlink-visible="[[sendLinkVisible]]" sendattachment-visible="[[sendAttachmentVisible]]"></thumb-div>
            </template>

        </iron-list>

        <div hidden$="{{!scrollLetterVisible}}">
            <paper-fab id="dd1" hidden$="{{!scrollControlVisible}}" on-click="scroll2Top" icon="av:skip-next" class="rotated"></paper-fab>
            <paper-fab id="dd2" hidden$="{{!scrollControlVisible}}" on-click="scrollUp" icon="av:fast-forward" class="rotated"></paper-fab>

            <paper-fab id="scrollLetterView" label="[[scrollLetter]]" on-click="openDropdown"></paper-fab>

            <paper-fab id="dd3" hidden$="{{!scrollControlVisible}}" on-click="scrollDown" icon="av:fast-rewind" class="rotated"></paper-fab>
            <paper-fab id="dd4" hidden$="{{!scrollControlVisible}}" on-click="scroll2End" icon="av:skip-previous" class="rotated"></paper-fab>
        </div>

    </template>

    <script>HTMLImports.whenReady(function(){Polymer({is:"poly-ebook-view",properties:{options:Object,files:Array,toastSuccessText:"File copied successfully.",toastErrorText:"",filteredFiles:{type:Array,value:[]},deleteVisible:{type:Boolean,value:!1},copyVisible:{type:Boolean,value:!1},sendLinkVisible:{type:Boolean,value:!1},sendAttachmentVisible:{type:Boolean,value:!1},thumbDims:Array,thumbDimsIndex:Number,thumbCss:{type:String},counterclass:{type:String,value:"green"},searchText:{type:String,value:""},itemCounterHidden:{type:Boolean,value:!0},scrollControlVisible:{type:Boolean,value:!1},scrollLetterVisible:{type:Boolean,value:!0},scrollLetter:"",listEle:HTMLElement,ajaxGetResponse:Object},observers:["_filterFiles(files, searchText)","_resetBySectionIndex(options.sectionIndex)","_resetByThumbDimsIndex(thumbDimsIndex)","onActionResponse(ajaxGetResponse)"],onActionResponse:function(e){if(e){var t=e.file;if(e.error)this.toastErrorText=e.msg,this.$.toastError.open();else if(console.info("response.method === delete:","delete"===e.method),"delete"===e.method){var i=this.options.sectionIndex+"/file"+t,s=this.filteredFiles.indexOf(i);s>-1&&this.filteredFiles.splice(s,1),s=this.files.indexOf(i),s>-1&&this.files.splice(s,1),this.listEle.fire("iron-resize")}else this.toastSuccessText=e.msg,this.$.toastSuccess.open()}},openDropdown:function(){this.scrollControlVisible=!this.scrollControlVisible},scroll2Top:function(){this.listEle.scrollToIndex(0)},scrollUp:function(){this.listEle.scrollToIndex(Math.max(0,Math.round(this.listEle.firstVisibleIndex-this.filteredFiles.length/10)))},scrollDown:function(){this.listEle.scrollToIndex(Math.min(this.filteredFiles.length-1,Math.round(this.listEle.firstVisibleIndex+this.filteredFiles.length/10)))},scroll2End:function(){this.listEle.scrollToIndex(this.filteredFiles.length-1)},clearInput:function(){this.searchText=""},_resetByThumbDimsIndex:function(e){this.scrollLetter="",this.thumbCss=["width:",this.thumbDims[this.thumbDimsIndex].width,"px;","height:",this.thumbDims[this.thumbDimsIndex].height,"px;"].join(""),document.querySelector("iron-list").fire("iron-resize")},_resetBySectionIndex:function(e){this.scrollLetter="";var t=this.options.sections[e];this.searchText=t.initialFilter,this.thumbDims=t.thumbsDims,this.thumbDimsIndex=t.dimIndex,this.deleteVisible=!!t.trashDir,this.copyVisible=!!t.copyDir,this.sendLinkVisible=!(!t.sendOptions||!t.sendOptions.sendlink),this.sendAttachmentVisible=!(!t.sendOptions||!t.sendOptions.sendattachment),this._resetByThumbDimsIndex(this.thumbDimsIndex)},_filterFiles:function(e,t){var i,s;this.scrollLetter="";var l=function(e){for(var t=0;t<s.length;t++){var i=s[t];if(i&&i.length>0){var l=i.substr(0,1);if("!"===l||"-"===l){if(i.length>1&&e.toLowerCase().indexOf(i.substr(1))>-1)return!1}else if(-1===e.toLowerCase().indexOf(i))return!1}}return!0};e||(i=null),i||t||(i=e),i||(s=t.toLowerCase().split(" "),i=e.filter(l)),this.filteredFiles=i,this.itemCounterHidden=this.filteredFiles.length===this.files.length,this.counterclass=0===this.filteredFiles.length?"red":this.itemCounterHidden?"green":"yellow",this.scrollControlVisible=!1,this.scrollLetterVisible=0!==this.filteredFiles.length,this._calcScrollLetter(),this.listEle.fire("iron-resize")},_getLoadFilesUrl:function(e){return void 0==e?null:"/"+e+"/files.json"},_calcScrollLetter:function(){var e=this.filteredFiles[this.listEle.firstVisibleIndex],t=Math.max(e.lastIndexOf("/"),e.lastIndexOf("\\"));this.scrollLetter=e?e.substr(t+1,1).trim().toUpperCase():""},attached:function(){console.info("attached..."),this.listEle=this.$.list;var e=this,t=function(){e._calcScrollLetter()};this._calcScrollLetter.bind(this),Polymer.RenderStatus.afterNextRender(this,function(){window.addEventListener("scroll",t),e.addEventListener("thumb-div-action",function(t){var i=t.detail,s=i.file;("delete"!==i.method||confirm("Do you really want to delete "+s+"?"))&&(e.$.ajaxGet.url=s.replace(/file[\/|\\]/,i.method+"/"),e.$.ajaxGet.generateRequest())})})},ready:function(){}})});</script>

</dom-module>
</body></html>