"use strict";function string2binary(r){var n=null;return n=support.uint8array?new Uint8Array(r.length):new Array(r.length),stringToArrayLike(r,n)}function identity(r){return r}function stringToArrayLike(r,n){for(var e=0;e<r.length;++e)n[e]=255&r.charCodeAt(e);return n}function arrayLikeToString(r){var n=65536,e=exports.getTypeOf(r),t=!0;if("uint8array"===e?t=arrayToStringHelper.applyCanBeUsed.uint8array:"nodebuffer"===e&&(t=arrayToStringHelper.applyCanBeUsed.nodebuffer),t)for(;n>1;)try{return arrayToStringHelper.stringifyByChunk(r,e,n)}catch(a){n=Math.floor(n/2)}return arrayToStringHelper.stringifyByChar(r)}function arrayLikeToArrayLike(r,n){for(var e=0;e<r.length;e++)n[e]=r[e];return n}var support=require("./support"),base64=require("./base64"),nodejsUtils=require("./nodejsUtils"),asap=require("asap"),external=require("./external");exports.newBlob=function(r,n){exports.checkSupport("blob");try{return new Blob([r],{type:n})}catch(e){try{var t=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,a=new t;return a.append(r),a.getBlob(n)}catch(e){throw new Error("Bug : can't construct the Blob.")}}};var arrayToStringHelper={stringifyByChunk:function(r,n,e){var t=[],a=0,o=r.length;if(o<=e)return String.fromCharCode.apply(null,r);for(;a<o;)"array"===n||"nodebuffer"===n?t.push(String.fromCharCode.apply(null,r.slice(a,Math.min(a+e,o)))):t.push(String.fromCharCode.apply(null,r.subarray(a,Math.min(a+e,o)))),a+=e;return t.join("")},stringifyByChar:function(r){for(var n="",e=0;e<r.length;e++)n+=String.fromCharCode(r[e]);return n},applyCanBeUsed:{uint8array:function(){try{return support.uint8array&&1===String.fromCharCode.apply(null,new Uint8Array(1)).length}catch(r){return!1}}(),nodebuffer:function(){try{return support.nodebuffer&&1===String.fromCharCode.apply(null,nodejsUtils.newBuffer(1)).length}catch(r){return!1}}()}};exports.applyFromCharCode=arrayLikeToString;var transform={};transform.string={string:identity,array:function(r){return stringToArrayLike(r,new Array(r.length))},arraybuffer:function(r){return transform.string.uint8array(r).buffer},uint8array:function(r){return stringToArrayLike(r,new Uint8Array(r.length))},nodebuffer:function(r){return stringToArrayLike(r,nodejsUtils.newBuffer(r.length))}},transform.array={string:arrayLikeToString,array:identity,arraybuffer:function(r){return new Uint8Array(r).buffer},uint8array:function(r){return new Uint8Array(r)},nodebuffer:function(r){return nodejsUtils.newBuffer(r)}},transform.arraybuffer={string:function(r){return arrayLikeToString(new Uint8Array(r))},array:function(r){return arrayLikeToArrayLike(new Uint8Array(r),new Array(r.byteLength))},arraybuffer:identity,uint8array:function(r){return new Uint8Array(r)},nodebuffer:function(r){return nodejsUtils.newBuffer(new Uint8Array(r))}},transform.uint8array={string:arrayLikeToString,array:function(r){return arrayLikeToArrayLike(r,new Array(r.length))},arraybuffer:function(r){return r.buffer},uint8array:identity,nodebuffer:function(r){return nodejsUtils.newBuffer(r)}},transform.nodebuffer={string:arrayLikeToString,array:function(r){return arrayLikeToArrayLike(r,new Array(r.length))},arraybuffer:function(r){return transform.nodebuffer.uint8array(r).buffer},uint8array:function(r){return arrayLikeToArrayLike(r,new Uint8Array(r.length))},nodebuffer:identity},exports.transformTo=function(r,n){if(n||(n=""),!r)return n;exports.checkSupport(r);var e=exports.getTypeOf(n),t=transform[e][r](n);return t},exports.getTypeOf=function(r){return"string"==typeof r?"string":"[object Array]"===Object.prototype.toString.call(r)?"array":support.nodebuffer&&nodejsUtils.isBuffer(r)?"nodebuffer":support.uint8array&&r instanceof Uint8Array?"uint8array":support.arraybuffer&&r instanceof ArrayBuffer?"arraybuffer":void 0},exports.checkSupport=function(r){var n=support[r.toLowerCase()];if(!n)throw new Error(r+" is not supported by this platform")},exports.MAX_VALUE_16BITS=65535,exports.MAX_VALUE_32BITS=-1,exports.pretty=function(r){var n,e,t="";for(e=0;e<(r||"").length;e++)n=r.charCodeAt(e),t+="\\x"+(n<16?"0":"")+n.toString(16).toUpperCase();return t},exports.delay=function(r,n,e){asap(function(){r.apply(e||null,n||[])})},exports.inherits=function(r,n){var e=function(){};e.prototype=n.prototype,r.prototype=new e},exports.extend=function(){var r,n,e={};for(r=0;r<arguments.length;r++)for(n in arguments[r])arguments[r].hasOwnProperty(n)&&"undefined"==typeof e[n]&&(e[n]=arguments[r][n]);return e},exports.prepareContent=function(r,n,e,t,a){var o=null;return o=support.blob&&n instanceof Blob&&"undefined"!=typeof FileReader?new external.Promise(function(r,e){var t=new FileReader;t.onload=function(n){r(n.target.result)},t.onerror=function(r){e(r.target.error)},t.readAsArrayBuffer(n)}):external.Promise.resolve(n),o.then(function(n){var o=exports.getTypeOf(n);return o?("arraybuffer"===o?n=exports.transformTo("uint8array",n):"string"===o&&(a?n=base64.decode(n):e&&t!==!0&&(n=string2binary(n))),n):external.Promise.reject(new Error("The data of '"+r+"' is in an unsupported format !"))})};