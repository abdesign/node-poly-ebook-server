EPUBJS.reader={},EPUBJS.reader.plugins={},function(e){var t=(e.ePubReader||{},e.ePubReader=function(e,t){return new EPUBJS.Reader(e,t)});"function"==typeof define&&define.amd?define(function(){return Reader}):"undefined"!=typeof module&&module.exports&&(module.exports=t)}(window,jQuery),EPUBJS.Reader=function(e,t){var o,n,r,i=this,s=$("#viewer"),a=window.location.search;this.settings=EPUBJS.core.defaults(t||{},{bookPath:e,restore:!1,reload:!1,bookmarks:void 0,annotations:void 0,contained:void 0,bookKey:void 0,styles:void 0,sidebarReflow:!1,generatePagination:!1,history:!0}),a&&(r=a.slice(1).split("&"),r.forEach(function(e){var t=e.split("="),o=t[0],n=t[1]||"";i.settings[o]=decodeURIComponent(n)})),this.setBookKey(this.settings.bookPath),this.settings.restore&&this.isSaved()&&this.applySavedSettings(),this.settings.styles=this.settings.styles||{fontSize:"100%"},this.book=o=new EPUBJS.Book(this.settings),this.settings.previousLocationCfi&&o.gotoCfi(this.settings.previousLocationCfi),this.offline=!1,this.sidebarOpen=!1,this.settings.bookmarks||(this.settings.bookmarks=[]),this.settings.annotations||(this.settings.annotations=[]),this.settings.generatePagination&&o.generatePagination(s.width(),s.height()),o.renderTo("viewer"),i.ReaderController=EPUBJS.reader.ReaderController.call(i,o),i.SettingsController=EPUBJS.reader.SettingsController.call(i,o),i.ControlsController=EPUBJS.reader.ControlsController.call(i,o),i.SidebarController=EPUBJS.reader.SidebarController.call(i,o),i.BookmarksController=EPUBJS.reader.BookmarksController.call(i,o),i.NotesController=EPUBJS.reader.NotesController.call(i,o);for(n in EPUBJS.reader.plugins)EPUBJS.reader.plugins.hasOwnProperty(n)&&(i[n]=EPUBJS.reader.plugins[n].call(i,o));return o.ready.all.then(function(){i.ReaderController.hideLoader()}),o.getMetadata().then(function(e){i.MetaController=EPUBJS.reader.MetaController.call(i,e)}),o.getToc().then(function(e){i.TocController=EPUBJS.reader.TocController.call(i,e)}),window.addEventListener("beforeunload",this.unload.bind(this),!1),window.addEventListener("hashchange",this.hashChanged.bind(this),!1),document.addEventListener("keydown",this.adjustFontSize.bind(this),!1),o.on("renderer:keydown",this.adjustFontSize.bind(this)),o.on("renderer:keydown",i.ReaderController.arrowKeys.bind(this)),o.on("renderer:selected",this.selectedRange.bind(this)),this},EPUBJS.Reader.prototype.adjustFontSize=function(e){var t,o=2,n=187,r=189,i=48,s=e.ctrlKey||e.metaKey;this.settings.styles&&(this.settings.styles.fontSize||(this.settings.styles.fontSize="100%"),t=parseInt(this.settings.styles.fontSize.slice(0,-1)),s&&e.keyCode==n&&(e.preventDefault(),this.book.setStyle("fontSize",t+o+"%")),s&&e.keyCode==r&&(e.preventDefault(),this.book.setStyle("fontSize",t-o+"%")),s&&e.keyCode==i&&(e.preventDefault(),this.book.setStyle("fontSize","100%")))},EPUBJS.Reader.prototype.addBookmark=function(e){var t=this.isBookmarked(e);t>-1||(this.settings.bookmarks.push(e),this.trigger("reader:bookmarked",e))},EPUBJS.Reader.prototype.removeBookmark=function(e){var t=this.isBookmarked(e);-1!==t&&(this.settings.bookmarks.splice(t,1),this.trigger("reader:unbookmarked",t))},EPUBJS.Reader.prototype.isBookmarked=function(e){var t=this.settings.bookmarks;return t.indexOf(e)},EPUBJS.Reader.prototype.clearBookmarks=function(){this.settings.bookmarks=[]},EPUBJS.Reader.prototype.addNote=function(e){this.settings.annotations.push(e)},EPUBJS.Reader.prototype.removeNote=function(e){var t=this.settings.annotations.indexOf(e);-1!==t&&delete this.settings.annotations[t]},EPUBJS.Reader.prototype.clearNotes=function(){this.settings.annotations=[]},EPUBJS.Reader.prototype.setBookKey=function(e){return this.settings.bookKey||(this.settings.bookKey="epubjsreader:"+EPUBJS.VERSION+":"+window.location.host+":"+e),this.settings.bookKey},EPUBJS.Reader.prototype.isSaved=function(){var e;return localStorage?(e=localStorage.getItem(this.settings.bookKey),null!==e):!1},EPUBJS.Reader.prototype.removeSavedSettings=function(){return localStorage?void localStorage.removeItem(this.settings.bookKey):!1},EPUBJS.Reader.prototype.applySavedSettings=function(){var e;if(!localStorage)return!1;try{e=JSON.parse(localStorage.getItem(this.settings.bookKey))}catch(t){return!1}return e?(e.styles&&(this.settings.styles=EPUBJS.core.defaults(this.settings.styles||{},e.styles)),this.settings=EPUBJS.core.defaults(this.settings,e),!0):!1},EPUBJS.Reader.prototype.saveSettings=function(){return this.book&&(this.settings.previousLocationCfi=this.book.getCurrentLocationCfi()),localStorage?void localStorage.setItem(this.settings.bookKey,JSON.stringify(this.settings)):!1},EPUBJS.Reader.prototype.unload=function(){this.settings.restore&&localStorage&&this.saveSettings()},EPUBJS.Reader.prototype.hashChanged=function(){var e=window.location.hash.slice(1);this.book["goto"](e)},EPUBJS.Reader.prototype.selectedRange=function(e){var t=new EPUBJS.EpubCFI,o=t.generateCfiFromRangeAnchor(e,this.book.renderer.currentChapter.cfiBase),n="#"+o;this.settings.history&&window.location.hash!=n&&(history.pushState({},"",n),this.currentLocationCfi=o)},RSVP.EventTarget.mixin(EPUBJS.Reader.prototype),EPUBJS.reader.BookmarksController=function(){var e=this.book,t=$("#bookmarksView"),o=t.find("#bookmarks"),n=document.createDocumentFragment(),r=function(){t.show()},i=function(){t.hide()},s=0,a=function(t){var o=document.createElement("li"),n=document.createElement("a");return o.id="bookmark-"+s,o.classList.add("list_item"),n.textContent=t,n.href=t,n.classList.add("bookmark_link"),n.addEventListener("click",function(t){var o=this.getAttribute("href");e.gotoCfi(o),t.preventDefault()},!1),o.appendChild(n),s++,o};return this.settings.bookmarks.forEach(function(e){var t=a(e);n.appendChild(t)}),o.append(n),this.on("reader:bookmarked",function(e){var t=a(e);o.append(t)}),this.on("reader:unbookmarked",function(e){var t=$("#bookmark-"+e);t.remove()}),{show:r,hide:i}},EPUBJS.reader.ControlsController=function(e){var t=this,o=($("#store"),$("#fullscreen")),n=($("#fullscreenicon"),$("#cancelfullscreenicon"),$("#slider")),r=($("#main"),$("#sidebar"),$("#setting")),i=$("#bookmark"),s=function(){t.offline=!1},a=function(){t.offline=!0},d=!1;return e.on("book:online",s),e.on("book:offline",a),n.on("click",function(){t.sidebarOpen?(t.SidebarController.hide(),n.addClass("icon-menu"),n.removeClass("icon-right")):(t.SidebarController.show(),n.addClass("icon-right"),n.removeClass("icon-menu"))}),"undefined"!=typeof screenfull&&(o.on("click",function(){screenfull.toggle($("#container")[0])}),screenfull.raw&&document.addEventListener(screenfull.raw.fullscreenchange,function(){d=screenfull.isFullscreen,d?o.addClass("icon-resize-small").removeClass("icon-resize-full"):o.addClass("icon-resize-full").removeClass("icon-resize-small")})),r.on("click",function(){t.SettingsController.show()}),i.on("click",function(){var e=t.book.getCurrentLocationCfi(),o=t.isBookmarked(e);-1===o?(t.addBookmark(e),i.addClass("icon-bookmark").removeClass("icon-bookmark-empty")):(t.removeBookmark(e),i.removeClass("icon-bookmark").addClass("icon-bookmark-empty"))}),e.on("renderer:locationChanged",function(e){var o="#"+e,n=t.isBookmarked(e);-1===n?i.removeClass("icon-bookmark").addClass("icon-bookmark-empty"):i.addClass("icon-bookmark").removeClass("icon-bookmark-empty"),t.currentLocationCfi=e,t.settings.history&&window.location.hash!=o&&history.pushState({},"",o)}),e.on("book:pageChanged",function(){}),{}},EPUBJS.reader.MetaController=function(e){var t=e.bookTitle,o=e.creator,n=$("#book-title"),r=$("#chapter-title"),i=$("#title-seperator");document.title=t+" â€“ "+o,n.html(t),r.html(o),i.show()},EPUBJS.reader.NotesController=function(){var e=this.book,t=this,o=$("#notesView"),n=$("#notes"),r=$("#note-text"),i=$("#note-anchor"),s=t.settings.annotations,a=e.renderer,d=[],l=new EPUBJS.EpubCFI,c=function(){o.show()},h=function(){o.hide()},u=function(o){var n,s,a,d,c,h=e.renderer.doc;if(h.caretPositionFromPoint?(n=h.caretPositionFromPoint(o.clientX,o.clientY),s=n.offsetNode,a=n.offset):h.caretRangeFromPoint&&(n=h.caretRangeFromPoint(o.clientX,o.clientY),s=n.startContainer,a=n.startOffset),3!==s.nodeType)for(var g=0;g<s.childNodes.length;g++)if(3==s.childNodes[g].nodeType){s=s.childNodes[g];break}a=s.textContent.indexOf(".",a),-1===a?a=s.length:a+=1,d=l.generateCfiFromTextNode(s,a,e.renderer.currentChapter.cfiBase),c={annotatedAt:new Date,anchor:d,body:r.val()},t.addNote(c),f(c),p(c),r.val(""),i.text("Attach"),r.prop("disabled",!1),e.off("renderer:click",u)},f=function(t){var o=document.createElement("li"),r=document.createElement("a");o.innerHTML=t.body,r.innerHTML=" context &#187;",r.href="#"+t.anchor,r.onclick=function(){return e.gotoCfi(t.anchor),!1},o.appendChild(r),n.append(o)},p=function(t){var o=e.renderer.doc,n=document.createElement("span"),r=document.createElement("a");n.classList.add("footnotesuperscript","reader_generated"),n.style.verticalAlign="super",n.style.fontSize=".75em",n.style.lineHeight="1em",r.style.padding="2px",r.style.backgroundColor="#fffa96",r.style.borderRadius="5px",r.style.cursor="pointer",n.id="note-"+EPUBJS.core.uuid(),r.innerHTML=s.indexOf(t)+1+"[Reader]",n.appendChild(r),l.addMarker(t.anchor,o,n),g(n,t.body)},g=function(e,o){var n=e.id,r=function(){var t,r,c,h,u=a.height,f=a.width,p=225;d[n]||(d[n]=document.createElement("div"),d[n].setAttribute("class","popup"),pop_content=document.createElement("div"),d[n].appendChild(pop_content),pop_content.innerHTML=o,pop_content.setAttribute("class","pop_content"),a.render.document.body.appendChild(d[n]),d[n].addEventListener("mouseover",i,!1),d[n].addEventListener("mouseout",s,!1),a.on("renderer:locationChanged",l,this),a.on("renderer:locationChanged",s,this)),t=d[n],r=e.getBoundingClientRect(),c=r.left,h=r.top,t.classList.add("show"),popRect=t.getBoundingClientRect(),t.style.left=c-popRect.width/2+"px",t.style.top=h+"px",p>u/2.5&&(p=u/2.5,pop_content.style.maxHeight=p+"px"),popRect.height+h>=u-25?(t.style.top=h-popRect.height+"px",t.classList.add("above")):t.classList.remove("above"),c-popRect.width<=0?(t.style.left=c+"px",t.classList.add("left")):t.classList.remove("left"),c+popRect.width/2>=f?(t.style.left=c-300+"px",popRect=t.getBoundingClientRect(),t.style.left=c-popRect.width+"px",popRect.height+h>=u-25?(t.style.top=h-popRect.height+"px",t.classList.add("above")):t.classList.remove("above"),t.classList.add("right")):t.classList.remove("right")},i=function(){d[n].classList.add("on")},s=function(){d[n].classList.remove("on")},l=function(){setTimeout(function(){d[n].classList.remove("show")},100)},h=function(){t.ReaderController.slideOut(),c()};e.addEventListener("mouseover",r,!1),e.addEventListener("mouseout",l,!1),e.addEventListener("click",h,!1)};return i.on("click",function(){i.text("Cancel"),r.prop("disabled","true"),e.on("renderer:click",u)}),s.forEach(function(e){f(e)}),a.registerHook("beforeChapterDisplay",function(e,t){var o=t.currentChapter;s.forEach(function(e){var t=l.parse(e.anchor);if(t.spinePos===o.spinePos)try{p(e)}catch(n){console.log("anchoring failed",e.anchor)}}),e()},!0),{show:c,hide:h}},EPUBJS.reader.ReaderController=function(e){var t=$("#main"),o=$("#divider"),n=$("#loader"),r=$("#next"),i=$("#prev"),s=this,e=this.book,a=function(){var o=e.getCurrentLocationCfi();s.settings.sidebarReflow?(t.removeClass("single"),t.one("transitionend",function(){e.gotoCfi(o)})):t.removeClass("closed")},d=function(){var o=e.getCurrentLocationCfi();s.settings.sidebarReflow?(t.addClass("single"),t.one("transitionend",function(){e.gotoCfi(o)})):t.addClass("closed")},l=function(){n.show(),u()},c=function(){n.hide()},h=function(){o.addClass("show")},u=function(){o.removeClass("show")},f=!1,p=function(t){37==t.keyCode&&("rtl"===e.metadata.direction?e.nextPage():e.prevPage(),i.addClass("active"),f=!0,setTimeout(function(){f=!1,i.removeClass("active")},100),t.preventDefault()),39==t.keyCode&&("rtl"===e.metadata.direction?e.prevPage():e.nextPage(),r.addClass("active"),f=!0,setTimeout(function(){f=!1,r.removeClass("active")},100),t.preventDefault())};return document.addEventListener("keydown",p,!1),r.on("click",function(t){"rtl"===e.metadata.direction?e.prevPage():e.nextPage(),t.preventDefault()}),i.on("click",function(t){"rtl"===e.metadata.direction?e.nextPage():e.prevPage(),t.preventDefault()}),e.on("renderer:spreads",function(e){e?h():u()}),{slideOut:d,slideIn:a,showLoader:l,hideLoader:c,showDivider:h,hideDivider:u,arrowKeys:p}},EPUBJS.reader.SettingsController=function(){var e=(this.book,this),t=$("#settings-modal"),o=$(".overlay"),n=function(){t.addClass("md-show")},r=function(){t.removeClass("md-show")},i=$("#sidebarReflow");return i.on("click",function(){e.settings.sidebarReflow=!e.settings.sidebarReflow}),t.find(".closer").on("click",function(){r()}),o.on("click",function(){r()}),{show:n,hide:r}},EPUBJS.reader.SidebarController=function(){var e=this,t=$("#sidebar"),o=$("#panels"),n="Toc",r=function(t){var r=t+"Controller";n!=t&&"undefined"!=typeof e[r]&&(e[n+"Controller"].hide(),e[r].show(),n=t,o.find(".active").removeClass("active"),o.find("#show-"+t).addClass("active"))},i=function(){return n},s=function(){e.sidebarOpen=!0,e.ReaderController.slideOut(),t.addClass("open")},a=function(){e.sidebarOpen=!1,e.ReaderController.slideIn(),t.removeClass("open")};return o.find(".show_view").on("click",function(e){var t=$(this).data("view");r(t),e.preventDefault()}),{show:s,hide:a,getActivePanel:i,changePanelTo:r}},EPUBJS.reader.TocController=function(e){var t=this.book,o=$("#tocView"),n=document.createDocumentFragment(),r=!1,i=function(e,t){var o=document.createElement("ul");return t||(t=1),e.forEach(function(e){var n=document.createElement("li"),r=document.createElement("a");toggle=document.createElement("a");var s;n.id="toc-"+e.id,n.classList.add("list_item"),r.textContent=e.label,r.href=e.href,r.classList.add("toc_link"),n.appendChild(r),e.subitems.length>0&&(t++,s=i(e.subitems,t),toggle.classList.add("toc_toggle"),n.insertBefore(toggle,r),n.appendChild(s)),o.appendChild(n)}),o},s=function(){o.show()},a=function(){o.hide()},d=function(e){var t=e.id,n=o.find("#toc-"+t),i=o.find(".currentChapter");o.find(".openChapter"),n.length&&(n!=i&&n.has(r).length>0&&i.removeClass("currentChapter"),n.addClass("currentChapter"),n.parents("li").addClass("openChapter"))};t.on("renderer:chapterDisplayed",d);var l=i(e);return n.appendChild(l),o.append(n),o.find(".toc_link").on("click",function(e){var n=this.getAttribute("href");e.preventDefault(),t["goto"](n),o.find(".currentChapter").addClass("openChapter").removeClass("currentChapter"),$(this).parent("li").addClass("currentChapter")}),o.find(".toc_toggle").on("click",function(e){var t=$(this).parent("li"),o=t.hasClass("openChapter");e.preventDefault(),o?t.removeClass("openChapter"):t.addClass("openChapter")}),{show:s,hide:a}};